<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tower Rush</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FFD700">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://unpkg.com/peerjs@1.5.0/dist/peerjs.min.js"></script>
    
    <!-- Core classes -->
    <script src="src/entities/Building.js"></script>
    <script src="src/entities/UnitGroup.js"></script>
    <script src="src/multiplayer/MultiplayerManager.js"></script>
    <script src="src/core/Game.js"></script>
</head>
<body>
    <div class="menu-screen" id="menuScreen">
        <div class="menu-content">
            <h1>Tower Rush</h1>
            <div class="menu-options">
                <div class="player-selection">
                    <label for="playerCount">Nombre de joueurs:</label>
                    <select id="playerCount">
                        <option value="2">2 Joueurs</option>
                        <option value="3">3 Joueurs</option>
                        <option value="4">4 Joueurs</option>
                    </select>
                </div>
                <div class="difficulty-selection">
                    <label for="aiDifficulty">Difficult√© IA:</label>
                    <select id="aiDifficulty">
                        <option value="easy">Facile</option>
                        <option value="medium" selected>Moyen</option>
                        <option value="hard">Difficile</option>
                    </select>
                </div>
                <div class="game-mode-selection">
                    <label for="gameMode">Mode de jeu:</label>
                    <select id="gameMode">
                        <option value="local">Local (vs IA)</option>
                        <option value="host">Multijoueur - Cr√©er partie</option>
                        <option value="join">Multijoueur - Rejoindre</option>
                    </select>
                </div>
                <div class="multiplayer-controls" id="multiplayerControls" style="display: none;">
                    <div class="room-code-section" id="roomCodeSection">
                        <label for="roomCode">Code de la partie:</label>
                        <input type="text" id="roomCode" placeholder="Entrez le code...">
                        <button id="copyCodeBtn" style="display: none;">Copier</button>
                    </div>
                    <div class="connection-status" id="connectionStatus">
                        <span id="statusText">En attente...</span>
                    </div>
                </div>
                <button id="startGameBtn">Commencer la Partie</button>
            </div>
        </div>
    </div>
    
    <!-- Lobby multijoueur -->
    <div class="lobby-screen" id="lobbyScreen" style="display: none;">
        <div class="lobby-content">
            <div class="lobby-header">
                <h1>Lobby - Tower Rush</h1>
                <div class="lobby-info">
                    <span class="room-code-display">Code: <span id="lobbyRoomCode"></span></span>
                    <button id="leaveLobbyBtn" class="leave-btn">Quitter</button>
                </div>
            </div>
            
            <div class="lobby-main">
                <div class="players-section">
                    <h3>Joueurs connect√©s</h3>
                    <div class="players-list" id="playersList">
                        <!-- Liste des joueurs sera g√©n√©r√©e ici -->
                    </div>
                    <div class="lobby-controls">
                        <button id="startGameLobbyBtn" class="start-game-btn" style="display: none;">D√©marrer la partie</button>
                        <div class="waiting-message" id="waitingMessage" style="display: none;">
                            En attente que l'h√¥te d√©marre la partie...
                        </div>
                    </div>
                </div>
                
                <div class="chat-section">
                    <h3>Chat</h3>
                    <div class="chat-messages" id="chatMessages">
                        <!-- Messages du chat -->
                    </div>
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" placeholder="Tapez votre message..." maxlength="200">
                        <button id="sendChatBtn">Envoyer</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="game-container" id="gameContainer" style="display: none;">
        <div class="game-header">
            <h1>Tower Rush</h1>
            <div class="game-info">
                <div class="player-info">
                    <span class="player-label">Joueur</span>
                    <span class="player-buildings" id="playerBuildings">0</span>
                </div>
                <div class="audio-controls">
                    <button id="musicToggleBtn" class="music-btn" title="Activer/D√©sactiver la musique">üîä</button>
                </div>
                <div class="enemy-info">
                    <span class="enemy-label">Ennemi</span>
                    <span class="enemy-buildings" id="enemyBuildings">0</span>
                </div>
            </div>
        </div>
        
        <div class="game-canvas-container">
            <canvas id="gameCanvas"></canvas>
        </div>
        
        <div class="game-controls">
            <div class="control-panel">
                <div class="selected-building">
                    <span id="selectedBuildingInfo">S√©lectionnez un b√¢timent</span>
                </div>
                <div class="action-buttons">
                    <div class="percentage-control">
                        <span class="percentage-label">Pourcentage:</span>
                        <span class="percentage-value" id="percentageInfo">50%</span>
                        <span class="percentage-hint">(molette)</span>
                    </div>
                    <button id="sendBtn" disabled>Envoyer</button>
                    <button id="backToMenuBtn">Menu</button>
                </div>
            </div>
        </div>
    </div>

    <div class="game-over" id="gameOver" style="display: none;">
        <div class="game-over-content">
            <h2 id="gameOverTitle">Fin de Partie</h2>
            <p id="gameOverMessage">Message</p>
            <button id="restartBtn">Recommencer</button>
        </div>
    </div>

    <script>
        // D√©marrer le jeu
        let game;
        window.addEventListener('load', () => {
            game = new Game();
        });
    </script>
    
    <script>
        // PWA uniquement si servi via HTTP/HTTPS
        if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('Service Worker enregistr√©:', registration.scope);
                    })
                    .catch(error => {
                        console.log('√âchec enregistrement Service Worker:', error);
                    });
            });
        } else {
            console.log('Service Worker non disponible (protocole file:// ou non support√©)');
        }
        
        // D√©tection PWA installable
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('PWA installable d√©tect√©e');
        });
    </script>
</body>
</html>